---
import { APP_BLOG } from 'astrowind:config';
import { getRelatedPosts } from '~/utils/blog';
import BlogHighlightedPosts from '../widgets/BlogHighlightedPosts.astro';
import type { Post } from '~/types';
import { getBlogPermalink } from '~/utils/permalinks';

interface Props {
  post: Post;
}

interface RelatedPost {
  id: string;
  slug: string;
  title: string;
  description?: string;
  tags?: string[];
}

const { post } = Astro.props;

// 1. Type the related posts array
let relatedPosts: RelatedPost[] = [];
try {
  relatedPosts = post.tags ? await getRelatedPosts(post, 4) : [];
} catch (error) {
  console.error('Error loading related posts:', error);
}

// 2. Generate schema.org data
const relatedPostsSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": relatedPosts.map((post, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": getBlogPermalink(post.slug),
    "name": post.title,
    "description": post.description || ""
  }))
};
---

<!-- 3. Wrapper with proper typing -->
<section 
  class="related-posts" 
  aria-label="Artikel terkait"
  itemscope 
  itemtype="http://schema.org/ItemList"
>
  {APP_BLOG.isRelatedPostsEnabled && (
    <>
      {relatedPosts.length > 0 ? (
        <BlogHighlightedPosts
          classes={{
            container: 'pt-0 lg:pt-0 md:pt-0 intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade'
          }}
          title="Artikel Terkait Lainnya"
          linkText="Lihat Semua Artikel"
          linkUrl={getBlogPermalink()}
          postIds={relatedPosts.map((post) => post.id)}
        />
      ) : (
        <div class="bg-gray-50 p-4 rounded-lg" itemprop="itemListElement">
          <p>Baca juga artikel populer kami:</p>
          <a 
            href={getBlogPermalink()} 
            class="text-primary-600 hover:underline"
            aria-label="Jelajahi semua artikel"
          >
            Jelajahi Blog
          </a>
        </div>
      )}

      <!-- 4. Fixed script tag with is:inline -->
      <script is:inline type="application/ld+json">
        {JSON.stringify(relatedPostsSchema)}
      </script>
    </>
  )}
</section>

<style is:global>
  .related-posts {
    scroll-margin-top: 2rem;
    position: relative;
  }
  .related-posts::before {
    content: "";
    display: block;
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    margin: 2rem 0;
  }
</style>
