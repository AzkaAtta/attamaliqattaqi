---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';
import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';
import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
  keywords?: string[];
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  keywords = [],
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'id',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);

// Default keywords jika tidak diisi
const defaultKeywords = [
  "jasa komentar instagram",
  "beli komentar instagram",
  "tambah komentar ig",
  "komentar ig murah",
  "jasa buzzer instagram",
  "jasa like instagram",
  "jasa view instagram",
  "auradigital"
];

const allKeywords = [...new Set([...keywords, ...defaultKeywords])].join(", ");

// Adapt open graph images
seoProps.openGraph = await adaptOpenGraphImages(seoProps?.openGraph, Astro.site);

// JSON-LD Schema
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": title || SITE?.name,
  "url": canonical,
  "description": description || METADATA?.description,
  "publisher": {
    "@type": "Organization",
    "name": SITE?.name,
    "logo": {
      "@type": "ImageObject",
      "url": SITE?.logo || "https://auradigital.id/logo.png"
    }
  }
};
---

<AstroSeo {...seoProps} />

<meta name="keywords" content={allKeywords} />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta charset="UTF-8" />
<meta name="author" content={SITE?.name} />
<meta name="theme-color" content="#ffffff" />

<script type="application/ld+json" is:inline>
  {JSON.stringify(jsonLd)}
</script>
